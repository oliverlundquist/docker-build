FROM oliverlundquist/php7:latest
MAINTAINER Oliver Lundquist "mail@oliverlundquist.com"

RUN docker-php-ext-install opcache

#         echo 'opcache.memory_consumption=512'; \
#         echo 'opcache.interned_strings_buffer=64'; \
#         echo 'opcache.max_accelerated_files=32531'; \

RUN { \
        echo 'opcache.enable=1'; \
        echo 'opcache.validate_timestamps=VALIDATE_TIMESTAMPS'; \
        echo 'opcache.revalidate_freq=REVALIDATE_FREQ'; \
        echo 'opcache.save_comments=1'; \
        echo 'opcache.fast_shutdown=0'; \
    } >> /usr/local/etc/php/conf.d/docker-php-ext-opcache.ini

RUN { \
        echo '#!/bin/sh'; \
        head -n -1 /root/run-script.sh; \
        echo 'sed -i.bak s/VALIDATE_TIMESTAMPS/${VALIDATE_TIMESTAMPS:-0}/g /usr/local/etc/php/conf.d/docker-php-ext-opcache.ini'; \
        echo 'sed -i.bak s/REVALIDATE_FREQ/${REVALIDATE_FREQ:-2}/g /usr/local/etc/php/conf.d/docker-php-ext-opcache.ini'; \
        echo 'exec $@'; \
    } > /root/run-script-opcache.sh \
    && mv /root/run-script-opcache.sh /root/run-script.sh \
    && chmod +x /root/run-script.sh
