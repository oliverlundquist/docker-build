FROM php:7.1.8-fpm
MAINTAINER Oliver Lundquist "mail@oliverlundquist.com"

RUN apt-get update && apt-get install -y \
        git \
        libfreetype6-dev \
        libjpeg62-turbo-dev \
        libmcrypt-dev \
        libpng12-dev \
    && docker-php-ext-install -j$(nproc) iconv mcrypt \
    && docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ \
    && docker-php-ext-install -j$(nproc) gd \
    && docker-php-ext-install pdo_mysql \
    && docker-php-ext-install zip

# Add www-data to root group, so that it has write permissions to storage/framework/views
RUN usermod -a -G root www-data

# Increase upload size limit to 4 MB
COPY docker/build/assets/uploads.ini /usr/local/etc/php/conf.d/uploads.ini

# Install New Relic PHP agent
RUN echo 'deb http://apt.newrelic.com/debian/ newrelic non-free' | tee /etc/apt/sources.list.d/newrelic.list \
    && curl -o- https://download.newrelic.com/548C16BF.gpg | apt-key add - \
    && apt-get update -y \
    && apt-get install -y newrelic-php5 \
    && NR_INSTALL_SILENT=true newrelic-install install

RUN { \
        echo '#!/bin/sh'; \
        echo 'sed -i.bak s/PHP\ Application/$NEWRELIC_APPNAME/g /usr/local/etc/php/conf.d/newrelic.ini'; \
        echo 'sed -i.bak s/REPLACE_WITH_REAL_KEY/$NEWRELIC_LICENSE/g /usr/local/etc/php/conf.d/newrelic.ini'; \
        echo 'usermod -u 500 www-data'; \
        echo 'groupmod -g 500 www-data'; \
        echo 'touch /var/app/current/storage/logs/lumen.log > /dev/null 2>&1'; \
        echo 'touch /var/app/current/storage/logs/laravel.log > /dev/null 2>&1'; \
        echo 'chmod 664 /var/app/current/storage/logs/lumen.log > /dev/null 2>&1'; \
        echo 'chmod 664 /var/app/current/storage/logs/laravel.log > /dev/null 2>&1'; \
        echo 'exec $@'; \
    } > /root/run-script.sh \
    && chmod +x /root/run-script.sh

RUN mkdir -p /var/app/current
WORKDIR /var/app/current

ENTRYPOINT ["/root/run-script.sh"]
CMD ["php-fpm"]
